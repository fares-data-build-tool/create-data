version: 2.1
orbs:
  semver-orb: tv2norge/semver-orb@0.0.1

jobs: 

  checkout-repo:
    docker:
      - image: circleci/node:latest
    working_directory: ~/project
    steps:
      - checkout
      - persist_to_workspace:
          root: ~/project
          paths:
            - "*"

  build-netex-convertor:
    docker:
      - image: circleci/node:latest
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          command: |
            cd netex-convertor
            npm install
            npm run build
      - persist_to_workspace:
          root: ~/project
          paths:
            - "netex-convertor/node_modules"

  test-netex-convertor:
    docker:
      - image: circleci/node:latest
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          command: |
            cd netex-convertor
            npm run test

  deploy-test-netex-convertor:
    docker:
      - image: circleci/node:latest
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          command: |
            sudo npm i -g serverless
            cd netex-convertor 
            export SLS_DEBUG="*" && sls deploy
            echo "Finished deploy"

  build-odh-uploader:
    docker:
      - image: circleci/node:latest
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          command: |
            cd odh-uploader
            npm install
            npm run build
      - persist_to_workspace:
          root: ~/project
          paths:
            - "odh-uploader/node_modules"

  test-odh-uploader:
    docker:
      - image: circleci/node:latest
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          command: |
            cd odh-uploader
            npm run test

  deploy-test-odh-uploader:
    docker:
      - image: circleci/node:latest
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          command: |
            sudo npm i -g serverless
            cd odh-uploader 
            export SLS_DEBUG="*" && sls deploy
            echo "Finished deploy"

  build-ref-data-uploader:
    docker:
      - image: circleci/node:latest
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          command: |
            cd ref-data-uploader
            npm install
            npm run build
      - persist_to_workspace:
          root: ~/project
          paths:
            - "ref-data-uploader/node_modules"

  test-ref-data-uploader:
    docker:
      - image: circleci/node:latest
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          command: |
            cd ref-data-uploader
            npm run test

  deploy-test-ref-data-uploader:
    docker:
      - image: circleci/node:latest
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          command: |
            sudo npm i -g serverless
            cd ref-data-uploader 
            export SLS_DEBUG="*" && sls deploy
            echo "Finished deploy"

  build-site:
    docker:
      - image: circleci/node:latest
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          command: |
            cd site
            npm install
            npm run build
      - persist_to_workspace:
          root: ~/project
          paths:
            - "site/node_modules"

  test-site:
    docker:
      - image: circleci/node:latest
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          command: |
            cd site
            npm run test

  deploy-test-site:
    docker:
      - image: circleci/node:latest
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          command: |
            sudo npm i -g serverless
            cd site
            export NODE_ENV='test' && export SLS_DEBUG="*" && sls deploy
            echo "Finished deploy"

  tag-test-release:
    executor: semver-orb/default
    steps:
      - add_ssh_keys:
          fingerprints:
            - "82:dc:89:ad:e9:41:c9:bd:db:e7:c1:84:68:c6:da:35"
      - attach_workspace:
          at: ~/project
      - semver-orb/print
      - semver-orb/tagnext
      - semver-orb/export-tag
      - semver-orb/print

workflows:
  version: 2
  build-and-test-deliverable-one-lambdas:
    jobs:
      - checkout-repo:
          context: "tfn-aws"
          filters:
            branches:
              only: develop

      - build-netex-convertor:
          requires:
            - checkout-repo
          context: "tfn-aws"
          filters:
            branches:
              only: develop
      - test-netex-convertor:
          requires:
            - build-netex-convertor
          context: "tfn-aws"
          filters:
            branches:
              only: develop
      - deploy-test-netex-convertor:
          requires:
            - test-netex-convertor
          context: "tfn-aws"
          filters:
            branches:
              only: develop

      - build-odh-uploader:
          requires:
            - checkout-repo
          context: "tfn-aws"
          filters:
            branches:
              only: develop
      - test-odh-uploader:
          requires:
            - build-odh-uploader
          context: "tfn-aws"
          filters:
            branches:
              only: develop
      - deploy-test-odh-uploader:
          requires:
            - test-odh-uploader
          context: "tfn-aws"
          filters:
            branches:
              only: develop


      - build-ref-data-uploader:
          requires:
            - checkout-repo
          context: "tfn-aws"
          filters:
            branches:
              only: develop
      - test-ref-data-uploader:
          requires:
            - build-ref-data-uploader
          context: "tfn-aws"
          filters:
            branches:
              only: develop
      - deploy-test-ref-data-uploader:
          requires:
            - test-ref-data-uploader
          context: "tfn-aws"
          filters:
            branches:
              only: develop

      - build-site:
          requires:
            - checkout-repo
          context: "tfn-aws"
          filters:
            branches:
              only: develop
      - test-site:
          requires:
            - build-site
          context: "tfn-aws"
          filters:
            branches:
              only: develop
      - deploy-test-site:
          requires:
            - test-site
          context: "tfn-aws"
          filters:
            branches:
              only: develop

      - tag-test-release:
          requires:
            - deploy-test-netex-convertor
            - deploy-test-odh-uploader
            - deploy-test-ref-data-uploader
            - deploy-test-site
          context: "tfn-aws"
          filters:
            branches:
              only: develop
