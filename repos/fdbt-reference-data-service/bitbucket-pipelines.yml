image: node:13.3.0

pipelines:
  default:
    - step:
        script:
          - node --version && npm --version
    - step:
        caches:
          - node-modules-netex-convertor
        script:
          - cd netex-convertor
          - npm ci
          - CI=true npm test -- --coverage --detectOpenHandles
    - step:
        caches:
          - node-modules-odh-uploader
        script:
          - cd odh-uploader
          - npm ci
          - CI=true npm test -- --coverage --detectOpenHandles
    - step:
        caches:
          - node-modules-naptan-uploader
        script:
          - cd naptan-uploader
          - npm ci
          - CI=true npm test -- --coverage --detectOpenHandles
    - step:
        caches:
          - node-modules-noc-uploader
        script:
          - cd noc-uploader
          - npm ci
          - CI=true npm test -- --coverage --detectOpenHandles
    - step:
        caches:
          - node-modules-nptg-uploader
        script:
          - cd nptg-uploader
          - npm ci
          - CI=true npm test -- --coverage --detectOpenHandles
    - step:
        caches:
          - node-modules-tnds-uploader
        script:
          - cd tnds-uploader
          - npm ci
          - CI=true npm test -- --coverage --detectOpenHandles
    - step:
        caches:
          - node-modules-site
        script:
          - cd site
          - npm ci
          - CI=true npm test -- --coverage --detectOpenHandles

definitions:
  caches:
    node-modules-netex-convertor: netex-convertor/node_modules
    node-modules-odh-uploader: odh-uploader/node_modules
    node-modules-naptan-uploader: naptan-uploader/node_modules
    node-modules-noc-uploader: noc-uploader/node_modules
    node-modules-nptg-uploader: nptg-uploader/node_modules
    node-modules-tnds-uploader: tnds-uploader/node_modules
    node-modules-site: site/node_modules
